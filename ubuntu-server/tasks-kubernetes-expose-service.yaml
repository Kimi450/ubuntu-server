
- name: "Create reverse proxy script to expose {{ service_name_part }}"
  block:
  - name: "Remove any old reverse proxy script"
    become: True
    file:
      path: "{{ service_script_file_location_base }}{{ service_script_file_name }}"
      state: absent

  - name: "Create new reverse proxy script"
    become: True
    lineinfile:
      path: "{{ service_script_file_location_base }}{{ service_script_file_name }}"
      line: "#!/bin/bash\nnohup kubectl port-forward -n {{ service_namespace }} svc/{{ release_name }}-{{ service_name_part }} {{ grafana_port }}:{{ service_container_port}} --address 0.0.0.0 > /dev/null 2>&1 &"
      mode: "0755"
      create: yes

- name: Setup and enable systemd service for port exposing
  block:
  - name: "Copy over the skeleton service file for systemd"
    become: True
    copy:
      src: charts-config/skeleton.service
      dest: "{{ service_file_location_base }}{{ service_file_name }}"

  - name: "Service file edit: Add reverse proxy script"
    become: True  
    lineinfile: 
      path: "{{ service_file_location_base }}{{ service_file_name }}"
      regexp: '^ExecStart=(.*)$' 
      line: "ExecStart={{ service_script_file_location_base }}{{ service_script_file_name }}"
      backrefs: yes
  
  - name: Reload to see new unit file
    become: True
    shell: systemctl daemon-reload

  - name: "Stop the service {{ service_file_name }}"
    become: True
    shell: "systemctl stop {{ service_file_name }}"
    ignore_errors: True

  - name: "Start the service {{ service_file_name }}"
    become: True
    shell: "systemctl start {{ service_file_name }}"

  - name: "Enable the service {{ service_file_name }}"
    become: True
    shell: "systemctl enable {{ service_file_name }}"
